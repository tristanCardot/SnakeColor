<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>SneakColor</title>
	<style>
		body{
			margin:0px;
		}

	</style>
	<script type="text/javascript" charset="UTF-8" src="three.min.js"></script>
	<script>
		var CANVAS;

		var COLOR = {
			BLACK: 0,
			GREEN: 1,
			RED: 2,
			YELLOW: 3,
			BLUE: 4,
			CYAN: 5,
			VIOLET: 6,
			WHITE: 7,
			RGB:[
				"(0,0,0)",
				"(0,255,0)",
				"(255,0,0)",
				"(255,255,0)",
				"(0,0,255)",
				"(0,255,255)",
				"(255,0,255)",
				"(255,255,255)"
			]
		};

		function Sneak(){
			this.pos = {x: 0, y: 0};
			this.maxLength = 5;
			this.speed = 250;

			this.parts = [];
			this.color = COLOR.GREEN;
		}

		Sneak.prototype = {
			growUp : function(){
				this.maxLength++;
			},

			update : function(){
				switch(keybinder.stat.dir){
					case 0: this.pos.y++;
						break;
					case 1: this.pos.x--;
						break;
					case 2: this.pos.y--;
						break;
					case 3: this.pos.x++;
						break;
				}

				if(! map.moveIn(this)){

				}
			},

			reset : function(){
				this.maxLength = 5;
				this.parts = [];
				this.color = COLOR.GREEN;
			}
		};

		var sneak = new Sneak();

		function Map(){
			this.currentData = null;
			this.grid = [];
			this.entities = [];

			this.height = 0;
			this.width = 0;

			this.spawn = {x: 0, y: 0};
		}

		Map.prototype = {
			loadFromData : function(levelData){
				this.currentData = levelData;

				this.height = levelData.height;
				this.width = levelData.width;

				this.grid = [];
				for(var i=-1, endI=his.width+1, endJ=this.height+1;  i<endI;  i++){
					this.grid.push([]);

					for(var j=-1; j<endJ; j++)
						this.grid[i].push(
								(i===0 || j===0 || i===this.width || j===this.height) ?
									1 : 0
							);
				}

				this.entityes = {};
			},

			clearEntity : function(pos){
				delete this.entities[pos];
			}
		};

		var map = new Map();

		function KeyBinder(){

			this.dir = -1;
			this.paused = false;

			window.addEventListener('keydown', function(e){
				switch(e.keyCode){
					case 69: case 87: case 38:
							this.dir = 0;
						break;

					case 83: case 40:
							this.dir = 2;
						break;

					case 81: case 65: case 37:
							this.dir = 1;
						break;

					case 68: case 39:
							this.dir = 3;
						break;

					case 80:
							//TODO pause
						break;
				}
			}, false);
		}

		KeyBinder.prototype = {
			bind : function(type, call){


			}
		};

		var keyBinder = new KeyBinder();

		function Animation(){



		}

		Animation.prototype = {





		};


		var GEO = {
			colorSwaper : (function(){
				var geo = new THREE.Geometry();
				geo.vertices = convertArray([
					-.4, .6, -.4,
					-.4, .6,  .4, 
					 .4, .6,  .4,
					 .4, .6, -.4,

					-.4,  0, -.4,
					-.4,  0,  .4,
					 .4,  0,  .4,
					 .4,  0, -.4
				], THREE.Vector3);

				geo.faces = convertArray([
					0,1,2, 0,2,3,
					1,5,6, 1,6,2

				], THREE.Face3);
					

				return geo;
			})(),

			ground : (function(){
				var geo = new THREE.Geometry();
				geo.vertices = convertArray([
					-.4,  0, -.4,
					-.4,  0,  .4,
					 .4,  0,  .4,
					 .4,  0, -.4,

					-.5, -.1, -.5,  
					-.5, -.1,  .5, 
					 .5, -.1,  .5, 
					 .5, -.1, -.5
				], THREE.Vector3);

				geo.faces = convertArray([
					0,1,2, 0,2,3,
					0,4,5, 0,5,1,
					1,5,6, 1,6,2,
					2,6,7, 2,7,3,
					3,7,4, 3,4,0
				], THREE.Face3);

				return geo;
			})(),

			wall : (function(){
				var geo = new THREE.Geometry();
				geo.vertices = convertArray([
					-.4,  .4, -.4,
					-.4,  .4,  .4,
					 .4,  .4,  .4,
					 .4,  .4, -.4,

					-.5,  .3, -.5,
					-.5,  .3,  .5,
					 .5,  .3,  .5,
					 .5,  .3, -.5,

					-.5, -.1, -.5,
					-.5, -.1,  .5,
					 .5, -.1,  .5,
					 .5, -.1, -.5
				], THREE.Vector3);

				geo.faces = convertArray([
					0,1,2, 0,2,3,
					0,4,5, 0,5,1,
					1,5,6, 1,6,2,
					2,6,7, 2,7,3,
					3,7,4, 3,4,0,

					4,8,9,   4,9,5,
					5,9,10,  5,10,6,
					6,10,11, 6,11,7,
					7,11,8,  7,8,4
				], THREE.Face3);

				return geo;
			})()
		};

		var MAT = {
			colorSwaper : function(rgb){
				var material = new THREE.ShaderMaterial({

				});
			},
			colorCube : function(list){
				var vert = [
					"#ifdef GL_ES",
					"precision mediump float;",
					"#endif",

		    		"varying float vGrad;",
		    		"attribute float grad;",

					"void main(){",
						"vGrad = grad;",
						"gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );",
					"}"
				].join('\n');
				var frag = [
					"#ifdef GL_ES",
					"precision mediump float;",
					"#endif",

		    		"varying float vGrad;",

					"void main(void){",
						"gl_FragColor = vec4(vGrad, vGrad, vGrad,1.);",
					"}"
				].join('\n');
				var attributes = [];

				return new THREE.ShaderMaterial({
			        uniforms:       {},
			        attributes:     {
			        	grad : {type: 'f', value: list}
			        },
			        vertexShader:   vert,
			        fragmentShader: frag
			    });
			}
		};

		function convertArray(list, type){
			var r = [];
			for(var i=0; i<list.length; i+=3)
				r.push(new type(list[i], list[i+1], list[i+2]));

			return r;
		}

		function ColorSwaper(color, pos){
			this.color = color;
			this.mesh = this.craftMesh();
		}

		ColorSwaper.prototype =	{
			moveIn : function(sneak){
				if(sneak.color !== this.color){
					sneak.color = this.color;
				}
				return true;
			},

			craftMesh : function(){
				return new THREE.Mesh(GEO.colorSwaper, MAT.colorSwaper(this.color));
			}
		};

		function Block(height){
			this.height = height;
			this.mesh = this.craftMesh();
		}

		Block.prototype = {
			moveIn : function(sneak){
				return this.height === 0;
			},

			craftMesh : function(){
				
			}
		};

		function Dot(color){
			this.color = color;
			this.mesh = this.craftMesh();
		}

		Dot.prototype = {
			moveIn : function(sneak){
				if(sneak.color === this.color){
					sneak.maxLength++;

					return true;
				}	
				else
					return false;
			},

			craftMesh : function(){
				
				
			}
		};

		var GROUNDS = [
			new Block(0),
			new Block(1)
		];

		var ENTITIES = [
			new ColorSwaper(COLOR.BLACK),
			new ColorSwaper(COLOR.GREEN),
			new ColorSwaper(COLOR.RED),
			new ColorSwaper(COLOR.YELLOW),
			new ColorSwaper(COLOR.BLUE),
			new ColorSwaper(COLOR.CYAN),
			new ColorSwaper(COLOR.VIOLET),
			new ColorSwaper(COLOR.WHITE),

			new Dot(COLOR.BLACK),
			new Dot(COLOR.GREEN),
			new Dot(COLOR.RED),
			new Dot(COLOR.YELLOW),
			new Dot(COLOR.BLUE),
			new Dot(COLOR.CYAN),
			new Dot(COLOR.VIOLET),
			new Dot(COLOR.WHITE)
		];

		function RenderManager(){
			this.cam = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 100);
			this.renderer = new THREE.WebGLRenderer({antialias: false});
   			this.scene = new THREE.Scene();

			CANVAS = this.renderer.domElement;
   			this.onRun = false;
   			this.lastTick = 0;

			var self = this;
			window.onresize = function(){self.updateSize();};
   			this.updateSize();
		}

		RenderManager.prototype = {
			startUpdate : function(){
				this.onRun = true;
				this.lastTick = Date.now();
				this.update(this);
			},

			stopUpdate : function(){
				this.onRun = false;
			},

			update : function(rm){//rm => RenderManager
				var delta = Date.now() -rm.lastTick;
				rm.lastTick += delta;

				if(rm.onRun)
					requestAnimationFrame(function(){rm.update(rm);});

				rm.renderer.render(rm.scene, rm.cam);
			},

			updateSize : function(e){
				this.cam.aspect = window.innerWidth /window.innerHeight;
				this.cam.updateProjectionMatrix();

				this.renderer.setSize( window.innerWidth, window.innerHeight);
				CANVAS.style.height = window.innerHeight-5 +'px';
				CANVAS.style.width = window.innerWidth +'px';
			}
		};

		var renderManager = new RenderManager();

		window.addEventListener('load', function(){
			document.body.appendChild(CANVAS);

			var geo = GEO.wall;
			geo.computeFaceNormals();
			geo.computeVertexNormals();


			for(var i=0; i<20; i++)
				for(var j=0; j<20; j++){
				var object = new THREE.Mesh( ((i+j)%5) <3 ? GEO.wall : GEO.ground , MAT.colorCube(((i+j)%5) <3 ? [.3,.3,.3,.3, .25,.25,.25,.25, .2,.2,.2,.2] : [.4,.4,.4,.4, .25,.25,.25,.25]));
				console.log(object.material);
				object.position.x = i-10;
				object.position.z = j-10;
				renderManager.scene.add(object);
			}

			renderManager.cam.position.y = 2;
			renderManager.cam.position.z = 1;
			renderManager.cam.rotation.x = -Math.PI/3;

			renderManager.renderer.render(renderManager.scene, renderManager.cam);

			renderManager.startUpdate();



		}, false);

		window.addEventListener('keypress', function(e){
			switch(e.keyCode){
				case 101: renderManager.cam.position.z--;
				break;
				case 100: renderManager.cam.position.z++;
				break;
				case 115: renderManager.cam.position.x--;
				break;
				case 102: renderManager.cam.position.x++;
				break;
				case 122: renderManager.cam.position.y--;
				break;
				case 114: renderManager.cam.position.y++;
				break;
			}


		}, false);
	</script>
</head>
<body>
</body>
</html>